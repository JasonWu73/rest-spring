<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.wuxianjie.web.user.UserMapper">
  <select id="findById" resultType="net.wuxianjie.web.user.User">
    SELECT user_id         AS userId,
           is_enabled      AS enabled,
           username,
           hashed_password AS hashedPassword,
           roles
    FROM users
    WHERE user_id = #{id}
  </select>

  <select id="findUserByUsername" resultType="net.wuxianjie.web.user.User">
    SELECT user_id         AS userId,
           is_enabled      AS enabled,
           username,
           hashed_password AS hashedPassword,
           roles
    FROM users
    WHERE username = #{username}
  </select>

  <select id="findByQueryPagingModifyTimeDesc"
          resultType="net.wuxianjie.web.user.ListOfUserItem">
    SELECT user_id                             AS userId,
    STRFTIME('%Y-%m-%d %H:%M:%S', modify_time) AS modifyTime,
    is_enabled                                 AS enabled,
    username,
    IFNULL(roles, '')                          AS roles
    FROM users
    <where>
      <if test="q.username != null">
        username LIKE #{q.username}
      </if>
      <if test="q.enabled != null">
        AND is_enabled = #{q.enabled}
      </if>
    </where>
    ORDER BY modify_time DESC
    LIMIT #{p.offset}, #{p.pageSize}
  </select>

  <select id="countByQuery" resultType="int">
    SELECT COUNT(1)
    FROM users
    <where>
      <if test="username != null">
        username LIKE #{username}
      </if>
      <if test="enabled != null">
        AND is_enabled = #{enabled}
      </if>
    </where>
  </select>

  <select id="existsUsername" resultType="boolean">
    SELECT EXISTS(SELECT 1 FROM users WHERE username = #{username})
  </select>

  <insert id="add" useGeneratedKeys="true" keyProperty="userId"
          parameterType="net.wuxianjie.web.user.User">
    INSERT INTO users (create_time,
                      modify_time,
                      is_enabled, username, hashed_password, roles)
    VALUES (DATETIME(CURRENT_TIMESTAMP, 'localtime'),
            DATETIME(CURRENT_TIMESTAMP, 'localtime'),
            #{enabled}, #{username}, #{hashedPassword}, #{roles})
  </insert>

  <update id="update">
    UPDATE users
    <set>
      modify_time = DATETIME(CURRENT_TIMESTAMP, 'localtime'),
      <if test="hashedPassword != null">
        hashed_password = #{hashedPassword},
      </if>
      <if test="roles != null">roles = #{roles},</if>
      <if test="enabled != null">is_enabled = #{enabled}</if>
    </set>
    WHERE user_id = #{userId}
  </update>

  <delete id="deleteById">
    DELETE FROM users WHERE user_id = #{id}
  </delete>
</mapper>
